#!/usr/bin/python
import sys
import os
sys.path.append(os.path.abspath(os.path.dirname(__file__))+"/../")
import core
import core.db

logger = core.get_logger(__name__)
config = core.get_config()

sys.path.append(os.path.abspath(os.path.dirname(__file__))+"/../sensors")
import ds18b20



def main(id,measure,task):
	for sensor in config["sensors"]:
		if sensor["id"] == id or id == "-": 
	                # determine the module to use
	                if sensor["plugin"] == "ds18b20": module = ds18b20
        	        if sensor["plugin"] == "wunderground": module = wunderground
			logger.info(sensor["id"]+" "+measure+" "+task)
			# execute the task
			if task == "read": 
				module.read(sensor,measure)
			if task == "parse":
				print module.parse(sensor,measure)
			if task == "save":
				module.save(sensore,measure)
				data = core.db.range(set_schema(sensor["id"]),withscores=True)
				timestamp = data[0][0]
				if core.now() - timestamp > core.sensors_expire:
					read(module,sensor)
				value = core.normalize(parse(module,sensor))
				logger.info("Saving")
				#core.db.set()
					

			

# allow running it both as a module and when called directly
if __name__ == '__main__':
        main(sys.argv[1],sys.argv[2],sys.argv[3])

