<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>myHouse</title>
<!-- Tell the browser to be responsive to screen width -->
<meta
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">

<!-- jQuery -->
<script src="web/jquery/jquery.min.js"></script>

<!-- Bootstrap -->
<script src="web/bootstrap/bootstrap.min.js"></script>
<link rel="stylesheet" href="web/bootstrap/bootstrap.min.css">

<!-- Font Awesome -->
<link rel="stylesheet" href="web/font-awesome/font-awesome.min.css">
<!-- <link rel="stylesheet" href="web/font-awesome/font-awesome-animation.min.css"> -->

<!-- SlimScroll -->
<script src="web/slimScroll/jquery.slimscroll.min.js"></script>

<!-- FastClick -->
<script src="web/fastclick/fastclick.min.js"></script>

<!--  PNotify -->
<script src="web/pnotify/pnotify.custom.js"></script>
<link rel="stylesheet" href="web/pnotify/pnotify.custom.min.css" />

<!--  Touchspin -->
<script src="web/touchspin/touchspin.min.js"></script>
<link rel="stylesheet" href="web/touchspin/touchspin.min.css" />

<!-- TitaToggle -->
<link rel="stylesheet" href="web/titatoggle/titatoggle.min.css" />

<!--  Datatables -->
<script src="web/datatables/datatables.min.js"></script>
<link rel="stylesheet" href="web/datatables/datatables.min.css" />
<link rel="stylesheet" href="web/datatables-plugins/dataTables.fontAwesome.css" />
	
<!--  Highstock -->
<script src="web/highstock/highstock-all.js"></script>
<script src="web/highstock/highcharts-more.js"></script>

<!--  AdminLTE -->
<link rel="stylesheet" href="web/AdminLTE/AdminLTE.css">
<link rel="stylesheet" href="web/AdminLTE/all-skins.css">

<!-- IE8 Respond -->
<!--[if lt IE 9]>
        <script src="web/IE8/html5shiv.min.js"></script>
        <script src="web/IE8/respond.min.js"></script>
    <![endif]-->
</head>
<style>
th.dt-center, td.dt-center { text-align: center; }
</style>

<body class="hold-transition skin-blue sidebar-mini">
	<div class="wrapper">

		<!-- =============================================== -->
		<header class="main-header">
			<a href="/" class="logo"> 
				<span class="logo-mini"><b>my</b>H</span> 
				<span class="logo-lg"><b><i class="fa fa-home"></i>
						my</b>House</span>
			</a>

			<nav class="navbar navbar-static-top" role="navigation">
				<a href="" class="sidebar-toggle" data-toggle="offcanvas" role="button"> 
					<span class="sr-only">Toggle navigation</span> 
					<span class="icon-bar"></span> 
					<span class="icon-bar"></span> 
					<span class="icon-bar"></span>
				</a>
				<div class="navbar-custom-menu">
					<ul class="nav navbar-nav">
						<li class="dropdown notifications-menu">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">
								<i class="fa fa-ban"></i>
								<span class="label label-danger" id="notification_alert_count"></span>
							</a>
							<ul class="dropdown-menu">
								<li>
									<ul class="menu" id="notification_alert"></ul>
								</li>
								<li class="footer"><a href="#alerts">View all</a></li>
							</ul>
						</li>
						<li class="dropdown notifications-menu">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">
								<i class="fa fa-warning"></i>
								<span class="label label-warning" id="notification_warning_count"></span>
							</a>
							<ul class="dropdown-menu">
								<li>
									<ul class="menu" id="notification_warning"></ul>
								</li>
								<li class="footer"><a href="#alerts">View all</a></li>
							</ul>
						</li>
						<li class="dropdown notifications-menu">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">
								<i class="fa fa-info"></i>
								<span class="label label-success" id="notification_info_count"></span>
							</a>
							<ul class="dropdown-menu">
								<li>
									<ul class="menu" id="notification_info"></ul>
								</li>
								<li class="footer"><a href="#alerts">View all</a></li>
							</ul>
						</li>
					</ul>
				</div>
			</nav>
		</header>

		<!-- =============================================== -->
		<aside class="main-sidebar">
			<section class="sidebar">

				<ul class="sidebar-menu">
					<li class="header"><a id="status"><i
							class="fa fa-circle text-red"></i> Offline</a></li>
				</ul>

				<ul class="sidebar-menu" id="menu">
				</ul>

			</section>
		</aside>

		<!-- =============================================== -->

		<div class="content-wrapper">
			<section class="content-header">
				<h1 id="title"></h1>
			</section>
			<section class="content">
				<div id="body"></div>
				<div style="padding: 10px 0px; text-align: center;">
					<div class="text-muted"><a href="#">Go to Top</a></div>
				</div>
			</section>
		</div>


		<!-- =============================================== -->
		<footer class="main-footer" id="footer">
			<div class="pull-right hidden-xs">
				<b>Version</b> <span id="version"></span>
			</div>
			<strong>Copyright &copy; 2016 <a>myHouse</a>.
			</strong> All rights reserved.
		</footer>

		<!-- =============================================== -->
	</div>

	<script src="web/AdminLTE/app.js"></script>
	<script src="web/AdminLTE/menu.js"></script>

	<script type="text/javascript">
	// current module
	var current_module = '';
	// configuration
	var conf = {};
	// refresher
	var refresher;
	// hostname
	var hostname = '';

	/**
		MAIN ENTRY POINT
	**/
	$(document).ready(function(){
		// request the configuration first
		$.getJSON(hostname+"config",function(data) {
			conf = data;
			// set the version
			load_version();
			// load the status
			load_status();
			// load the side menu
			load_menu();
			// load the alerts
			load_alerts();
			// load the given module
			current_module = conf['general']['default_module'];
			if (location.hash) current_module = location.hash.replace('#','');
			load_module(current_module);
			// whenever the hash changes, load the requested module
			window.onhashchange = function() {
				if (location.hash) current_module = location.hash.replace('#','');
				load_module(current_module);
			};
			// set auto-refresh
			auto_refresh(conf["web"]["auto_refresh_min"]);
		});
	});

	/**
		LOAD MAIN PAGE COMPONENTS
	**/

	// load the internet status and public hostname
	function load_status() {
		log("info","loading internet status");
		$.getJSON(hostname+"internet_status",function(data) {
			$("#status").html('<i class="fa fa-circle text-success"></i><span title="'+data.hostname+' ('+data.region+')">'+data.hostname+'</span>');
			log("info","current hostname: "+data.hostname);
		});
	}
	
	// load menu
	function load_menu() {
		log("info","loading menu");
		// empty the menu
		$("#menu").empty()
		var menu = '<li class="header">MENU</li>';
		for (var i = 0; i < conf['modules'].length; i++) {
			// for each module add it to the menu
			var module = conf['modules'][i];
			if (! module['enabled']) continue;
			log("info","adding menu item "+module['display_name']);
			menu = menu + '<li><a href="#'+module['module_id']+'"> <i class="fa '+module['icon']+'"></i> <span>'+capitalizeFirst(module['display_name'])+'</span></a></li>';
		}
		$("#menu").html(menu);
	}
	
	// load version
	function load_version() {
		log("info","setting version to "+conf['constants']['version_string']);
		$("#version").html(conf['constants']['version_string']);
	}
	
	// load alerts
	function load_alerts() {
		log("info","loading alerts");
		severity = ['alert','warning','info']
		for (var i = 0; i < severity.length; i++) {
			// retrieve the alerts
			$.getJSON(hostname+"alerts/"+severity[i]+"/recent",function(severity) {
				return function (data) {
					var widget = "#notification_"+severity;
					var widget_counter = "#notification_"+severity+"_count"
					// empty the widget
					$(widget).empty()
					$(widget_counter).html("")
					// set the counter
					if (data.length > 0) $(widget_counter).html(data.length)
					for (var j = 0; j < data.length; j++) {
						// for each alert, add it to the list
						$(widget).prepend('<li><a href="#alerts" title="'+data[j][1]+'">'+data[j][1]+'</a></li>')
					}
				};
			}(severity[i]));			
		}
	}
	
	// load module
	function load_module(module_id) {
		log("info","loading module "+module_id);
		// clean up the body
		$("#body").empty();
		// load data from the sensors of the current module
		load_widgets(module_id);
	}	

	// load data the widgets of the current module
	function load_widgets(module_id) {
		$("#body").append('<div id="widgets"></div>');
		var module = get_module(module_id);
		$("#title").text(module["display_name"]);
		if (module == null) return;
		if (! ('widgets' in module)) return;
		for (var i = 0; i < module["widgets"].length; i++) {
			// for each row
			var row = module_id+"_"+i;
			$("#widgets").append('<div class="row" id="'+row+'">');
			for (var j = 0; j < module["widgets"][i].length; j++) {
				// for each widget
				widget = module["widgets"][i][j];
				log("info","["+module_id+"] loading widget "+widget["widget_id"]);
				if (widget["size"] == 0) continue;
				// add an empty widget template
				tag = "#"+widget["widget_id"];
				$("#"+row).append(get_widget_template(tag,widget["display_name"],widget["size"]));
				// add the current measure header if requested
				if ("current" in widget || "current_icon" in widget) add_current_measure_header(tag,widget)
				else add_empty_header(tag)
				// load the requested widget
				if (widget["type"] == "sensor_group_summary") add_sensor_group_summary_chart(tag+"_body",widget);				
				else if (widget["type"] == "image") add_sensor_image(tag+"_body",widget);
				else if (widget["type"] == "sensor_group_timeline") add_sensor_group_timeline_chart(tag+"_body",widget);
				else if (widget["type"] in conf["constants"]["charts"]) add_sensor_chart(tag+"_body",widget);
				else if (widget["type"] == "alerts") add_alerts_widget(tag+"_body",widget);
				else if (widget["type"] == "input_on_off") add_input_on_off_widget(tag+"_body",widget);
			}
			// end of the row
			$("#"+row).append('</div>');
		}
	}
	
	/**
		WIDGETS
	**/
	
	// add a sensor summary widget
	function add_sensor_group_summary_chart(tag,widget) {
		split = split_group(widget,"group")
		if (split == null) return;
		module_id = split[0]
		group_id = split[1]; 
		group = get_group(module_id,group_id)
		var options = $.extend(true,{}, conf["constants"]["charts"]["chart_sensor_group_summary"]);
		if ("current" in widget) options["chart"]["height"] = conf["constants"]["chart_short_height"]
		$(tag).highcharts(options);
		var chart = $(tag).highcharts();
		// for each sensor	
		for (var i = 0; i < group["sensors"].length; i++) {
			var sensor = group["sensors"][i];
			var sensor_url = module_id+"/sensors/"+group["group_id"]+"/"+sensor["sensor_id"];
			// skip flags
			if (sensor['format'] == 'string') continue;
			// add the sensor to the xAxis
			chart['xAxis'][0]['categories'].push(sensor["display_name"]);
			// add the point for yesterday's range
			add_point(chart,sensor_url+"/yesterday/range",0);
			// add the point for today's range
			add_point(chart,sensor_url+"/today/range",1);
		}
	}
	
	// add a sensor timeline widget
	function add_sensor_group_timeline_chart(tag,widget) {
		split = split_group(widget,"group")
		if (split == null) return;
		module_id = split[0]
		group_id = split[1];
		group = get_group(module_id,group_id)
		var options = $.extend(true,{},conf["constants"]["charts"]["chart_"+widget["type"]+"_"+widget["timeframe"]]);
		if ("current" in widget) options["chart"]["height"] = conf["constants"]["chart_short_height"]
		$(tag).highcharts('StockChart',options);
		var chart = $(tag).highcharts();
		// for each sensor
		for (var i = 0; i < group["sensors"].length; i++) {
			var sensor = group["sensors"][i];
			var sensor_url = module_id+"/sensors/"+group["group_id"]+"/"+sensor["sensor_id"];
			if (! ("series" in sensor)) continue;
			// add each series, to the chart
			for (var j = 0; j < sensor["series"].length; j++) {
				series = sensor["series"][j]
				add_series(chart,sensor_url+"/"+widget["timeframe"]+"/"+series["series_id"],sensor,j);
			}
		}
	}	
	
	// add a generic sensor chart widget
	function add_sensor_chart(tag,widget) {
		split = split_sensor(widget,"sensor")
		if (split == null) return;
		module_id = split[0]
		group_id = split[1]
		sensor_id = split[2];
		var sensor = get_sensor(module_id,group_id,sensor_id)
		var sensor_url = module_id+"/sensors/"+group_id+"/"+sensor_id;
		// add the chart
		var options = $.extend(true,{}, conf["constants"]["charts"][widget["type"]]);
		if ("current" in widget) options["chart"]["height"] = conf["constants"]["chart_short_height"]
		if (sensor["format"] == "percentage") options["yAxis"]["max"] = 100;
		$(tag).highcharts(options);
		var chart = $(tag).highcharts();
		// add each series to the chart
		if (! ("series" in sensor)) return;
		for (var i = 0; i < sensor["series"].length; i++) {
			series = sensor["series"][i];
			add_series(chart,sensor_url+"/"+widget["timeframe"]+"/"+series["series_id"],sensor,i);
		}
	}
	
	// add an image widget
	function add_sensor_image(tag,widget) {
		split = split_sensor(widget,"sensor")
		if (split == null) return;
		module_id = split[0]
		group_id = split[1]
		sensor_id = split[2];
		var sensor = get_sensor(module_id,group_id,sensor_id)
		var sensor_url = module_id+"/sensors/"+group_id+"/"+sensor_id;
		// add the image to the widget
		$(tag).html('<img class="img-responsive" src="'+sensor_url+"/current"+'" />');
	}
	
	// add an alert widget
	function add_alerts_widget(tag,widget) {
		// define the alerts table
		var table_html = '<table id="alerts_table" class="table table-bordered table-striped">\
							<thead>\
								<tr>\
									<th>Severity</th>\
									<th>Time</th>\
									<th>Message</th>\
								</tr>\
							</thead>\
							<tbody></tbody>\
						  </table>';
		// define datatables options
		var options = {
			"paging": true,
			"lengthChange": false,
			"searching": true,
			"ordering": true,
			"info": true,
			"autoWidth": true,
			"columnDefs": [
				{
					"targets": 0,
					"width": "10%",
					"render": function ( data, type, row ) {
						if (data == "alert") { icon = "ban"; color = "#dd4b39" }
						else if (data == "warning") { icon = "warning"; color = "#f39c12" }
						else if (data == "info") { icon = "info"; color = "#0073b7" }
						return '<i class="icon fa fa-'+icon+'" style="color:'+color+'"></i>'
					},
					"className": "dt-center",
				},
				{
					"targets": 1,
					"width": "10%",
					"className": "dt-center",
				},
				{
					"targets": 2,
					"width": "80%",
				},
			],
		};
		// create the widget and the table
		$(tag).append(table_html);
		$("#alerts_table").DataTable(options);
		var table = $("#alerts_table").DataTable();
		// add alerts to the table
		var severity = ['alert','warning','info']
		for (var i = 0; i < severity.length; i++) {
			// retrieve the alerts
			$.getJSON(hostname+"alerts/"+severity[i]+"/history",function(severity) {
				return function (data) {
					for (var j = 0; j < data.length; j++) {
						// for each alert, add it to the table
						table.row.add([severity,data[j][0],data[j][1]]).draw(false);
					}
					// reorder the data
					table.order( [ 1, 'desc' ] ).draw();
				};
			}(severity[i]));
		}
	}
	
	// add an on/off input widget
	function add_input_on_off_widget(tag,widget) {
		$(tag).html("")
		$(tag).append('<div class="container">')
		if ("checkbox" in widget) bind_html_control(tag,widget,"checkbox")
		if ("input" in widget) bind_html_control(tag,widget,"input")
		$(tag).append('</div>')
	}
	
	/**
		WIDGET HELPER FUNCTIONS
	**/	
	
	// return an empty HTML widget template
	function get_widget_template(tag,title,size) {
		tag = tag.replace("#","")
		// define the widget HTML
		var html = '\
					<div class="col-md-#size#">\
							<div class="box box-solid box-primary">\
								<div class="box-header">\
									<h3 class="box-title">#title#</h3>\
								</div>\
								<div class="box-body no-padding box-primary">\
								    <div class="box-body" id="#tag#" align="center">\
									</div>\
								</div>\
							</div>\
					</div>\
				';		
		// replace the placeholders with the provided input
		html = html.replaceAll("#size#",size);
		html = html.replaceAll("#title#",title);
		html = html.replaceAll("#tag#",tag);
		return html;
	}
	
	// add the current measure widget
	function add_current_measure_header(tag,widget) {
		tag = tag.replace("#","")
		split = split_sensor(widget,"current")
		if (split == null) return;
		module_id = split[0]
		group_id = split[1]
		sensor_id = split[2];
		var sensor = get_sensor(module_id,group_id,sensor_id)
		if (sensor == null) return;
		var sensor_url = module_id+"/sensors/"+group_id+"/"+sensor_id;
		var summary_body = '\
			<div class="box-profile">\
				<img class="profile-user-img img-responsive img-circle" id="'+tag+'_icon" src="web/images/unknown.png">\
					<h3 class="profile-username text-center"><span id="'+tag+'_current"></span><span id="'+tag+'_current_suffix"></span></h3>\
					<p class="text-muted text-center" id="'+tag+'_timestamp"></p>\
					<ul class="list-group list-group-unbordered">\
						<li class="list-group-item" id="'+tag+'_body">\
						</li>\
					</ul>\
				<div>';
		tag = "#"+tag;
		// add the summary body to it
		$(tag).html(summary_body);
		// add the summary icon
		if ("current_icon" in widget) {
			$(tag+"_icon").attr('src',widget["current_icon"]);
		}
		// set the current measure
		if ("current" in widget) {
			set_html(tag+"_current",sensor_url+"/current");
			$(tag+"_current_suffix").html(conf['constants']['formats'][sensor['format']]['suffix']);
			// set the timestamp
			set_html(tag+"_timestamp",sensor_url+"/timestamp");
		}
	}
	
	// add an empty widget header
	function add_empty_header(tag) {
		tag = tag.replace("#","")
		$("#"+tag).append('<div id="'+tag+'_body"></div>')
	}
	
	// add and bind a html input
	function bind_html_control(tag,widget,type) {
		tag = tag.replace("#","")
		// define the HTML inputs
		checkbox_html = '<div class="row"><div class="col-sm-6 col-sm-offset-4"><div class="checkbox checkbox-slider--a checkbox-slider-lg"><label><input type="checkbox" id="'+tag+'_checkbox"><span></span></label></div></div></div>'
		input_html = '<div class="row"><div class="col-sm-12"><div class="input-group input-group-lg"><input style="text-align:center;" id="'+tag+'_input" class="form-control input-lg" type="text" value=""></div></div></div>'
		tag = "#"+tag
		// add the HTML of the requested input
		if (type == "input") {
			// add the input box
			$(tag).append(input_html);
			$(tag+"_"+type).TouchSpin({
					min: 0,
					max: 100,
					step: 0.1,
					decimals: 1,
					boostat: 5,
					maxboostedstep: 10,
			});
		} 
		else if (type == "checkbox") {
			// add the checkbox
			$(tag).append(checkbox_html);	
		}
		// retrieve the sensor to control
		split = split_sensor(widget,type)
		if (split == null) return;
		var module_id = split[0]
		var group_id = split[1]
		var sensor_id = split[2];
		var sensor_url = module_id+"/sensors/"+group_id+"/"+sensor_id;
		// set the current value
		$.getJSON(hostname+sensor_url+"/current",function(tag) {
			return function (data) {
				if (data.length > 0) {
					if (type == "input") $(tag).val(data[0])
					if (type == "checkbox") {
						if (data[0] == "on") $(tag).prop("checked",1);
						if (data[0] == "off") $(tag).prop("checked",0);
					}
				}
			};
		}(tag+"_"+type));
		// listen for changes
		$(tag+"_"+type).change(function(tag,sensor_url,type) {
			return function () {
				// set the new value
				if (type == "input") var new_value = $(tag).val();
				if (type == "checkbox") var new_value = $(tag).is(':checked') ? "on" : "off";
				$.getJSON(hostname+sensor_url+"/set/"+new_value,function(tag,new_value,type) {
					return function (data) {
						if (data != "OK") {
							// handle errors
							if (type == "input") log.warning("error setting value "+new_value+" to "+sensor_url);
							if (type == "checkbox") $(tag).prop("checked", !$(tag).prop("checked"));
						}
					};
				}(tag,new_value,type));
			};
		}(tag+"_"+type,sensor_url,type));
	}
	
	
	/**
		CHART HELPER FUNCTIONS
	**/	
	
	// add a new series to a chart
	function add_series(chart,url,sensor,series_index) {
		$.getJSON(hostname+url, function(chart,sensor,series_index) {
				return function (data) {
					// get the series template
					var series = $.extend(true,{}, sensor['series'][series_index]);
					// set the name and the id
					series['name'] = sensor['display_name']+" "+sensor['series'][series_index]['series_id'];
					series['id'] = sensor['sensor_id']+":"+sensor['series'][series_index]['series_id'];
					// add the sensor suffix and tooltip
					apply_format(series,sensor['format']);
					//add the data to it
					series['data'] = data;
					// if the data is a string, add flags
					if (sensor['format'] == 'string') {
						flags = [];
						for (var i = 0; i < data.length; i++) {
							if (data[i][1] == null) continue;
							flags[i] = {'x': data[i][0], 'shape': 'circlepin', 'title': '<img width="'+series['width']+'" heigth="'+series['heigth']+'" src="web/images/'+sensor['sensor_id']+"_"+data[i][1]+'.png">'};
						}
						series['data'] = flags;
					}
					// attach the series to the chart
					chart.addSeries(series);
				};
		}(chart,sensor,series_index));
	}
	
	// add a new point to an existing series
	function add_point(chart,url,series_index) {
		$.getJSON(hostname+url, function(chart,series_index) {
				return function (data) {
					// add the data as a new point to an existing series
					chart.series[series_index].addPoint(data);
				};
		}(chart,series_index));
	}

	/**
		OTHER HELPER FUNCTIONS 
	**/
	
	// helper to replace all occurences in a string
	String.prototype.replaceAll = function (find, replace) {
		var str = this;
		return str.replace(new RegExp(find.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), replace);
	};
	
	// capitalize the first letter
	function capitalizeFirst(string) {
		return string.charAt(0).toUpperCase() + string.slice(1);
	}
	
	// set the html of a given tag
	function set_html(tag,url) {
		$.getJSON(hostname+url, function(tag) {
				return function (data) {
					if (data.length != 1) $(tag).html("");
					$(tag).html(data[0]);
				};
		}(tag));
	}
	
	// set an image src
	function set_img(tag,url,prefix,suffix) {
		$.getJSON(hostname+url, function(tag) {
				return function (data) {
					if (data.length != 1) return;
					$(tag).attr('src','web/images/'+prefix+data[0]+suffix);
				};
		}(tag,prefix,suffix));
	}

	// apply a given format to a chart series
	function apply_format(series,format) {
		if (!('tooltip' in series)) series['tooltip'] = {};
		if (!('dataLabels' in series)) series['dataLabels'] = {};
		series['tooltip']['valueSuffix'] = conf['constants']['formats'][format]['suffix'];
		series['dataLabels']['format'] = '{y}'+conf['constants']['formats'][format]['suffix'];
	}
	
	// return a module data
	function get_module(module_id) {
		if (module_id == null) module_id = current_module;
		for (var i = 0; i < conf["modules"].length; i++) {
			var module = conf["modules"][i];
			if (module["module_id"] == module_id) return module;
		}
	}
	
	// return a sensor group data
	function get_group(module_id,group_id) {
		module = get_module(module_id);
		if (module == null) return null;
		if (!("sensor_groups" in module)) return null;
		for (var i = 0; i < module["sensor_groups"].length; i++) {
			var group = module["sensor_groups"][i];
			if (group["group_id"] == group_id) return group;
		}
	}
	
	// return a sensor data
	function get_sensor(module_id,group_id,sensor_id) {
		group = get_group(module_id,group_id);
		if (group == null) return null;
		if (!("sensors" in group)) return null;
		for (var j = 0; j < group["sensors"].length; j++) {
			var sensor = group["sensors"][j];
			if (sensor["sensor_id"] == sensor_id) return sensor;
		}
	}
	
	// return a actuator data
	function get_actuator(module_id,actuator_id) {
		module = get_module(module_id);
		if (module == null) return null;
		if (!("actuators" in module)) return null;
		for (var i = 0; i < module["actuators"].length; i++) {
			var actuator = module["actuators"][i];
			if (actuator["actuator_id"] == actuator_id) return actuator;
		}
	}
	
	// split group
	function split_group(widget,key) {
		// ensure the key is in widget
		if (!(key in widget)) {
			log("warning","Unable to find "+key+" in widget "+widget["widget_id"])
			return null
		}
		// split it
		split = widget[key].split(":")
		// ensure the group exists
		group = get_group(split[0],split[1])
		if (group == null) {
			log("warning","Unable to find group "+key+" for widget "+widget["widget_id"])
			return null
		}
		return split
	}
	
	// split sensor
	function split_sensor(widget,key) {
		// ensure the key is in widget
		if (!(key in widget)) {
			log("warning","Unable to find "+key+" in widget "+widget["widget_id"])
			return null
		}
		// split it
		split = widget[key].split(":")
		// ensure the sensor exists
		sensor = get_sensor(split[0],split[1],split[2])
		if (sensor == null) {
			log("warning","Unable to find sensor "+key+" for widget "+widget["widget_id"])
			return null
		}
		return split
	}

	// split actuator
	function split_actuator(widget,key) {
		// ensure the key is in widget
		if (!(key in widget)) {
			log("warning","Unable to find "+key+" in widget "+widget["widget_id"])
			return null
		}
		// split it
		split = widget[key].split(":")
		// ensure the actuator exists
		actuator = get_actuator(split[0],split[1])
		if (actuator == null) {
			log("warning","Unable to find actuator "+key+" for widget "+widget["widget_id"])
			return null
		}
		return split
	}	

	// auto refresh the page
	function auto_refresh(minutes) {
		if (!(minutes > 0)) return;
		if (refresher) clearInterval(refresher);
		refresher = setInterval(function(){
			load_module(current_module);
			load_alerts();
		}, minutes*60*1000);
	}
	
	// log to console a message
	function log(level,message) {
		if (conf["web"]["debug_console"] || level != "info") console.log(level.toUpperCase()+": "+message);
	}
	</script>

</body>
</html>
